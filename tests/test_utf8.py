import queue

from dogmon.datastore import DataStore
from dogmon import interface
from dogmon import logfile


def test_utf8():
    list_log_lines = \
           ['65.55.213.74 - - [17/May/2015:15:05:45 +0000] "GET /blog/tags/ì°¦ì°¨ë¥¼ íƒ€ê³  ì˜¨ í²ì‹œë§¨ê³¼ ì‘›ë‹¤ë¦¬ ë˜ ë°©ê°í•˜ HTTP/1.1" 404 19423',
            '65.55.213.74 - - [17/May/2015:15:05:36 +0000] "GET /tag/geekery/ìš¸ë€ë°”í† ë¥´ HTTP/1.1" 404 13358',
            '65.55.213.74 - - [17/May/2015:15:05:34 +0000] "GET /blog/tags/â€©testâ€© HTTP/1.1" 404 10021',
            '65.55.213.74 - - [17/May/2015:15:05:57 +0000] "GET /tag/geekery/è¡¨ãƒã‚Aé·—Å’Ã©ï¼¢é€ÃœÃŸÂªÄ…Ã±ä¸‚ã€ HTTP/1.1" 404 10021',
            '65.55.213.74 - - [17/May/2015:15:05:15 +0000] "GET /blog/tags/Ê‡unpá´‰pá´‰É”uá´‰ HTTP/1.1" 404 39692',
            '65.55.213.74 - - [17/May/2015:15:05:21 +0000] "GET /blog/tags/ğŸ³0ğŸŒˆï¸ HTTP/1.1" 404 32742',
            '68.180.224.225 - - [17/May/2015:15:05:19 +0000] "GET /blog/tags/á¹°ÌºÌºÌ•oÍ Ì·iÌ²Ì¬Í‡ÌªÍ™nÌÌ—Í•vÌŸÌœÌ˜Ì¦ÍŸoÌ¶Ì™Ì°Ì kÃ¨ÍšÌ®ÌºÌªÌ¹Ì±Ì¤ Ì–tÌÍ•Ì³Ì£Ì»ÌªÍhÌ¼Í“Ì²Ì¦Ì³Ì˜Ì²eÍ‡Ì£Ì°Ì¦Ì¬Í Ì¢Ì¼Ì»Ì±Ì˜hÍšÍÍ™ÌœÌ£Ì²Í…iÌ¦Ì²Ì£Ì°Ì¤vÌ»ÍeÌºÌ­Ì³ÌªÌ°-mÌ¢iÍ…nÌ–ÌºÌÌ²Ì¯Ì°d HTTP/1.1" 404 9983',
            '65.55.213.74 - - [17/May/2015:15:05:20 +0000] "GET /blog/tags/â¤ï¸ ğŸ’” ğŸ’Œ ğŸ’• ğŸ’ ğŸ’“ ğŸ’— ğŸ’– ğŸ’˜ ğŸ’ ğŸ’Ÿ ğŸ’œ ğŸ’› ğŸ’š ğŸ’™ HTTP/1.1" 404 11113',
            '65.55.213.73 - - [17/May/2015:15:05:57 +0000] "GET /tag/geekery/ğŸ‡ºğŸ‡¸ğŸ‡·ğŸ‡ºğŸ‡¸ ğŸ‡¦ğŸ‡«ğŸ‡¦ğŸ‡²ğŸ‡¸ HTTP/1.1" 404 9514',
            '65.55.213.73 - - [17/May/2015:15:05:40 +0000] "GET /blog/tags/Ø§Ù„ØªÙ‘ÙØ·Ù’Ø¨ÙÙŠÙ‚ÙØ§ØªÙ Ø§Ù„Ù’Ø­Ø§Ø³ÙÙˆØ¨ÙÙŠÙ‘ÙØ©Ù HTTP/1.1" 404 40797'
           ]

    queue_log_lines = queue.Queue()
    for line in list_log_lines:
        queue_log_lines.put(line)

    data = DataStore(log_lines = queue_log_lines)
    for log_line in data.log_lines():
        stats = logfile.parse_line(log_line)
        if stats:
            data.stats_update(*stats)
            data.hits_increment()

    assert(data.top_not_found() ==
           [('/blog/tags/ì°¦ì°¨ë¥¼ íƒ€ê³  ì˜¨ í²ì‹œë§¨ê³¼ ì‘›ë‹¤ë¦¬ ë˜ ë°©ê°í•˜', 1),
            ('/tag/geekery/ìš¸ë€ë°”í† ë¥´', 1),
            ('/blog/tags/\u2029test\u2029', 1),
            ('/tag/geekery/è¡¨ãƒã‚Aé·—Å’Ã©ï¼¢é€ÃœÃŸÂªÄ…Ã±ä¸‚ã€', 1),
            ('/blog/tags/Ê‡unpá´‰pá´‰É”uá´‰', 1),
            ('/blog/tags/ğŸ³0ğŸŒˆï¸', 1),
            ('/blog/tags/á¹°ÌºÌºÌ•oÍ Ì·iÌ²Ì¬Í‡ÌªÍ™nÌÌ—Í•vÌŸÌœÌ˜Ì¦ÍŸoÌ¶Ì™Ì°Ì kÃ¨ÍšÌ®ÌºÌªÌ¹Ì±Ì¤ Ì–tÌÍ•Ì³Ì£Ì»ÌªÍhÌ¼Í“Ì²Ì¦Ì³Ì˜Ì²eÍ‡Ì£Ì°Ì¦Ì¬Í Ì¢Ì¼Ì»Ì±Ì˜hÍšÍÍ™ÌœÌ£Ì²Í…iÌ¦Ì²Ì£Ì°Ì¤vÌ»ÍeÌºÌ­Ì³ÌªÌ°-mÌ¢iÍ…nÌ–ÌºÌÌ²Ì¯Ì°d', 1),
            ('/blog/tags/â¤ï¸ ğŸ’” ğŸ’Œ ğŸ’• ğŸ’ ğŸ’“ ğŸ’— ğŸ’– ğŸ’˜ ğŸ’ ğŸ’Ÿ ğŸ’œ ğŸ’› ğŸ’š ğŸ’™', 1),
            ('/tag/geekery/ğŸ‡ºğŸ‡¸ğŸ‡·ğŸ‡ºğŸ‡¸ ğŸ‡¦ğŸ‡«ğŸ‡¦ğŸ‡²ğŸ‡¸', 1),
            ('/blog/tags/Ø§Ù„ØªÙ‘ÙØ·Ù’Ø¨ÙÙŠÙ‚ÙØ§ØªÙ Ø§Ù„Ù’Ø­Ø§Ø³ÙÙˆØ¨ÙÙŠÙ‘ÙØ©Ù', 1)])
